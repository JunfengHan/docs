# Kubernetes æ ¸å¿ƒæ¦‚å¿µ

> 2021 å¹´ï¼Œæƒ³éƒ¨ç½²ä¸€ä¸ªåº”ç”¨çš„è¯ï¼ŒDocker åº”è¯¥æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œk8s æ˜¯å¿…å¤‡æŠ€èƒ½ã€‚

## 1. ä»€ä¹ˆæ˜¯ k8s?

**k8s**æ˜¯ä¸€ä¸ªåŸºäº`å®¹å™¨`çš„åˆ†å¸ƒå¼æ¶æ„æ–¹æ¡ˆã€‚

å…³äº k8s çš„ä½ è¦çŸ¥é“ï¼š

- å®ƒçš„å‰èº«æ˜¯ Google çš„ Brog(google å†…éƒ¨è¶…çº§å¼ºå¤§çš„é›†ç¾¤ç®¡ç†ç³»ç»Ÿ)
- k8s å¯ä»¥å¢åŠ è¿ç»´æ•ˆç‡ï¼Œå‡å°‘è¿ç»´æˆæœ¬
- K8s æ˜¯ä¸€ä¸ªå¼€æ”¾æ€§çš„å¼€å‘å¹³å°ï¼Œå’Œè¯­è¨€æ— å…³ï¼ˆæ— è®ºä½ çš„é¡¹ç›®ä½¿ç”¨çš„æ˜¯ Javaã€Goã€Python è¿˜æ˜¯ NodeJsï¼‰
- K8s æ˜¯ä¸€ä¸ªå®Œå¤‡çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ”¯æ’‘å¹³å°ï¼Œå…·æœ‰å®Œå¤‡çš„é›†ç¾¤ç®¡ç†èƒ½åŠ›

## 2. k8s ä¼˜ç‚¹

- å›¢é˜Ÿå¯ä»¥â€œè½»è£…ä¸Šé˜µâ€ï¼Œéœ€è¦çš„è¿ç»´å·¥ä½œé‡å¤§å¤§å‡å°‘ï¼Œè´¨é‡å¤§å¤§æé«˜
- æ‹¥æŠ±**å¾®æœåŠ¡**
- å¯ä»¥éšæ—¶éšåœ°å°†ç³»ç»Ÿâ€œæ¬è¿â€ä¸Šäº‘
- **å¼¹æ€§æ‰©å®¹**å¯ä»¥è½»æ¾åº”å¯¹æµé‡é«˜å³°
- å¯ä»¥å¿«é€Ÿæ¨ªå‘æ‰©å®¹ï¼Œè½»æ¾åº”å¯¹ç”¨æˆ·æ¿€å¢

## 3. k8s ç»„æˆ

- kubeadm
  k8s çš„ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨å®ƒåˆå§‹åŒ–ã€ç®¡ç† K8s é›†ç¾¤ï¼›
- kubelet
  ç®¡ç†å·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œçš„å®¹å™¨ï¼›
- kubectl
  kubectl æ˜¯ Kubernetes API çš„ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå¯ä»¥è°ƒç”¨ä»»ä½• Kubernetes APIï¼Œåšè‡ªå·±æƒ³åšçš„ï¼›

ç²¾å½©æ–‡ç« ï¼š[How kubeadm Initializes Your Kubernetes Master](https://www.ianlewis.org/en/how-kubeadm-initializes-your-kubernetes-master)

[What is kubectl?](https://dockerlabs.collabnix.com/kubernetes/beginners/what-is-kubect.html)

## 4. k8s æ ¸å¿ƒæ¦‚å¿µ

k8s ä¸­çš„æœ¯è¯­å¤§å¤šå›´ç»•`èµ„æºå¯¹è±¡ï¼ˆResource Objectï¼‰`è€Œè¨€çš„ï¼Œå¯ä»¥å¤§è‡´åˆ†ä¸ºä¸¤ç±»ï¼š

#### 1. æŸç§å…·ä½“èµ„æºå¯¹è±¡ï¼šå¦‚ï¼šèŠ‚ç‚¹ï¼ˆNodeï¼‰ã€Podã€æœåŠ¡ï¼ˆServiceï¼‰ã€å­˜å‚¨å·ï¼ˆVolumeï¼‰

#### 2. ä¸èµ„æºç›¸å…³çš„äº‹ç‰©ä¸åŠ¨ä½œï¼šå¦‚ï¼šæ ‡ç­¾ï¼ˆLabelï¼‰ã€æ³¨é‡Šï¼ˆAnnotationï¼‰ã€å‘½åç©ºé—´ï¼ˆNamespaceï¼‰ã€éƒ¨ç½²ï¼ˆDeploymentï¼‰ã€HPAã€PVC ç­‰ã€‚

`èµ„æºå¯¹è±¡ï¼ˆResource Objectï¼‰`é€šå¸¸ä¸€å®šæœ‰åç§°ã€æ ‡ç­¾ã€æ³¨é‡Šè¿™ 3 ä¸ªå…ƒæ•°æ®ï¼ˆmetadataï¼‰ï¼›

æˆ‘ä»¬å¯ä»¥é€šè¿‡ YAML æˆ– JSON æ ¼å¼æ¥å£°æ˜ä¸€ä¸ª K8s`èµ„æºå¯¹è±¡ï¼ˆResource Objectï¼‰`ï¼Œç„¶åæŠŠå®ƒä»¬å­˜æ”¾åœ¨ etcd è¿™æ ·çš„éå…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œä¾¿äºå¿«é€Ÿè¯»å†™ï¼›

`èµ„æºå¯¹è±¡ï¼ˆResource Objectï¼‰`ä¹Ÿå¯ä»¥ä½¿ç”¨*kubectl*å·¥å…·æ‰§è¡Œå¢ã€åˆ ã€æ”¹ã€æŸ¥ã€‚

_ä¸€ä¸ª k8s ç¼–æ’æ–‡ä»¶é‡Œå«æœ‰å¤šä¸ª`èµ„æºå¯¹è±¡ï¼ˆResource Objectï¼‰`ï¼š_

```yaml
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: azure-vote-back
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: azure-vote-back
    spec:
      containers:
        - name: azure-vote-back
          image: redis
          ports:
            - containerPort: 6379
              name: redis
---
apiVersion: v1
kind: Service
metadata:
  name: azure-vote-back
spec:
  ports:
    - port: 6379
  selector:
    app: azure-vote-back
---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: azure-vote-front
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: azure-vote-front
    spec:
      containers:
        - name: azure-vote-front
          image: microsoft/azure-vote-front:v1
          ports:
            - containerPort: 80
          env:
            - name: REDIS
              value: "azure-vote-back"
---
apiVersion: v1
kind: Service
metadata:
  name: azure-vote-front
spec:
  type: LoadBalancer
  ports:
    - port: 80
  selector:
    app: azure-vote-front
```

_k8s èµ„æºå¯¹è±¡å›¾ç¤ºï¼š_

![](./img/k8s_resourceObject.jpeg)

### 4.1 é›†ç¾¤ç±»

é›†ç¾¤ä¸­çš„æœºå™¨è¢«åˆ’åˆ†ä¸ºä¸€ä¸ª**Master**å’Œå¤šä¸ª**Node**

- `Master`ä¸Šè¿è¡Œç€ç®¡ç†é›†ç¾¤çš„è¿›ç¨‹ï¼Œå¦‚ï¼š
  - **kube-apiserver**ï¼šæ¥å£ APIï¼Œé€šè¿‡æ¥å£å¯ä»¥å¯¹å®¹å™¨é‡Œæ‰€æœ‰èµ„æºå¢åˆ æ”¹æŸ¥--é›†ç¾¤çš„å…¥å£ï¼›
  - **kube-controller-manager**ï¼šå¯¹ k8s çš„èµ„æºè‡ªåŠ¨åŒ–æ§åˆ¶--å¤§æ€»ç®¡ï¼›
  - **kube-sechuduler**ï¼šå®ƒä»¬å®ç°äº†å¯¹é›†ç¾¤çš„èµ„æºç®¡ç†ã€Pod è°ƒåº¦ã€å¼¹æ€§ä¼¸ç¼©ç­‰--è°ƒåº¦å®¤
- **`Node`**: é›†ç¾¤çš„å·¥ä½œèŠ‚ç‚¹ï¼Œå…¶ä¸Šè¿è¡Œç€å…·ä½“çš„å·¥ä½œè¿›ç¨‹ï¼Œå¦‚ï¼š
  - **kubelet**ï¼š è´Ÿè´£ Pod å¯¹å®¹å™¨çš„åˆ›å»ºã€å¯åœç­‰ä»»åŠ¡ ğŸŒŸğŸŒŸï¼Œä¸ Master åä½œï¼Œå®ç°é›†ç¾¤ç®¡ç†çš„åŸºæœ¬åŠŸèƒ½
  - **kube-proxy**ï¼šè´Ÿè´£*kubenetes service*çš„**é€šä¿¡**ï¼Œä»¥åŠå®ç°è½¯ä»¶æ¨¡å¼çš„**è´Ÿè½½å‡è¡¡**ğŸŒŸğŸŒŸ

### 4.2 åº”ç”¨ç±»

- `Deploayment`: å·¥ä½œè´Ÿè½½
  - æä¾›äº† Pod çš„æ¨¡ç‰ˆï¼Œå®ç°è‡ªåŠ¨åˆ›å»º Pod
- `Service`ï¼šk8s ä½¿ç”¨ Service æ¥è¿æ¥æŒ‡å®šçš„æœåŠ¡
  - æ‹¥æœ‰ä¸€ä¸ªæŒ‡å®šçš„åç§°ï¼Œå¯ä»¥æ˜¯å¤šä¸ªå‰¯æœ¬æä¾›æœåŠ¡ï¼ˆæ— çŠ¶æ€ï¼‰ï¼Œä¹Ÿå¯æ˜¯æŸä¸ªå…·ä½“çš„æœåŠ¡ï¼Œå¦‚ mysql-server
  - æ‹¥æœ‰ä¸€ä¸ªè™šæ‹Ÿ IP å’Œç«¯å£å·ï¼ˆClusterIPï¼‰ï¼šå¦‚ 192.13.34.4:3001ï¼Œè¿™ä¸ª K8s çš„é‡è¦â€¼ï¸ æœºåˆ¶ï¼Œå®ƒå®ç°äº† k8s å†…éƒ¨ DNS é‡Œ**åç§°---IP**çš„æ˜ å°„ï¼Œå¯ä»¥é€šè¿‡**åç§°**ç›´æ¥æ‰¾åˆ°**æœåŠ¡**
  - å¯ä»¥å°†å®¢æˆ·ç«¯å¯¹æœåŠ¡çš„è®¿é—®è¯·æ±‚è½¬å‘åˆ°ä¸€ç»„å®¹å™¨
- `Pod`ï¼šæœåŠ¡è¿›ç¨‹å®¹å™¨åœ¨ Pod ä¸­è¿è¡Œ
  - **Pod**æ˜¯ K8s ç®¡ç†çš„æœ€å°å•ä½
  - **Pod**è¿è¡Œåœ¨ä¸€ä¸ªè¢«ç§°ä¸º**èŠ‚ç‚¹ï¼ˆNodeï¼‰**çš„ç¯å¢ƒä¸­ï¼Œ**èŠ‚ç‚¹ï¼ˆNodeï¼‰**å¯ä»¥æ˜¯ç‰©ç†æœºï¼Œä¹Ÿå¯ä»¥æ˜¯äº‘å¹³å°çš„è™šæ‹Ÿæœº
  - ä¸€ä¸ª**èŠ‚ç‚¹ï¼ˆNodeï¼‰**å¯ä»¥è¿è¡Œå¤šä¸ª**Pod**
  - æ¯ä¸ª Pod ä¸­éƒ½è¿è¡Œç€ä¸€ä¸ªç‰¹æ®Šçš„è¢«ç§°ä¸º**Pause**çš„å®¹å™¨ï¼Œå…¶ä»–å®¹å™¨åˆ™ä¸º**ä¸šåŠ¡å®¹å™¨**ï¼Œ**ä¸šåŠ¡å®¹å™¨**å…±äº«**Pause**å®¹å™¨å†…çš„*ç½‘ç»œ*å’Œ*Volume*ï¼Œå› æ­¤ï¼Œå®ƒä»¬ä¹‹é—´çš„é€šä¿¡å’Œæ•°æ®äº¤æ¢æ˜¯é«˜æ•ˆçš„
  - ä¸ºäº†å»ºç«‹ Service å’Œ Pod çš„è¿æ¥ï¼Œéœ€è¦ç»™ Pod è´´ä¸Š**æ ‡ç­¾**ï¼ˆå¦‚ï¼šname = mysqlã€name=phpï¼‰
  - **Deployment å®šä¹‰æ–‡ä»¶**ï¼Œå®šä¹‰äº† Podï¼Œk8s å¯ä»¥æ ¹æ®**Deployment**æ¥è‡ªåŠ¨åˆ›å»ºç¬¦åˆè¦æ±‚çš„ Podï¼Œå¤§å¤§æé«˜è¿ç»´æ•ˆç‡
- `Label`:è¿™é‡Œçš„ Label æŒ‡ä¸€ä¸ª key=value é”®å€¼å¯¹
  - ä¸€ä¸ª Label å¯ä»¥æ·»åŠ ç»™å¤šä¸ªèµ„æºå¯¹è±¡ï¼Œå¦‚ Nodeã€Podã€Serviceã€Deployment ç­‰
  - ä¸€ä¸ªèµ„æºå¯¹è±¡ä¸Šå¯ä»¥æœ‰å¤šä¸ª Label
  - Label ä½œç”¨æ˜¯ï¼šè®©èµ„æºå®ç°**å¤šç»´åº¦åˆ†ç»„ç®¡ç†åŠŸèƒ½**ğŸŒŸï¼Œå’Œ Label Select å…±åŒæ„æˆäº† K8s ç³»ç»Ÿæ ¸å¿ƒçš„åº”ç”¨æ¨¡å‹
  - Label æ˜¯ Pod çš„é‡è¦å±æ€§ï¼Œé‡è¦æ€§ä»…æ¬¡äº Pod çš„ç«¯å£
  - **Label Selector(æ ‡ç­¾é€‰æ‹©å™¨)**ï¼šæŸ¥è¯¢å’Œç­›é€‰æ‹¥æœ‰æŸäº› Label çš„èµ„æºå¯¹è±¡
- `Serviceç½‘ç»œé€šä¿¡`
  - Node IPï¼šçœŸå®æœåŠ¡å™¨çš„ IP åœ°å€ï¼ŒK8s èŠ‚ç‚¹å¤–çš„ Node IP å¯ä»¥è®¿é—® K8s é‡Œçš„ TCP/IP æœåŠ¡ï¼ŒçœŸå®çš„ TCP/IP æµé‡æ˜¯ Node IP æ‰€åœ¨çš„ç½‘å¡æµå‡ºçš„
  - Pod IPï¼šæ¯ä¸ª Pod çš„ IP åœ°å€ï¼Œä½¿ç”¨ Docker åšå®¹å™¨æ—¶ï¼Œå®ƒæ˜¯ Docker Engine æ ¹æ® docker0 ç½‘æ¡¥çš„ IP åˆ†é…çš„ï¼Œæ˜¯ä¸€ä¸ªè™šæ‹ŸäºŒå±‚ç½‘ç»œã€‚K8s é›†ç¾¤é‡Œçš„ Pod é—´é€šä¿¡å°±æ˜¯é€šè¿‡è¿™ä¸ªäºŒå±‚ç½‘ç»œ
  - `Service IP`: Service çš„ ClusterIP åœ°å€å±äºé›†ç¾¤å†…çš„åœ°å€ï¼Œæ— æ³•åœ¨é›†ç¾¤å¤–ç›´æ¥ä½¿ç”¨ã€‚**NodePort**è§£å†³äº†é›†ç¾¤å¤–è®¿é—®é›†ç¾¤å†…æœåŠ¡çš„ç›´æ¥æœ‰æ•ˆã€æœ‰æ•ˆæ–¹æ³•ã€‚
- `Replica Set(å‰¯æœ¬é›†)`:
  - **å‰¯æœ¬é›†**ç¡®ä¿åœ¨ä»»ä½•æ—¶å€™éƒ½æœ‰æŒ‡å®šæ•°é‡çš„ pod å¤åˆ¶åœ¨è¿è¡Œ
  - **å‰¯æœ¬é›†**å¸®åŠ©ä½ å®šä¹‰å¤šå°‘ä¸ª**Pod**æ˜¯å¯ç”¨çš„ï¼Œå¦‚æœä½ æŠŠ**å‰¯æœ¬é›†**å®šä¹‰ä¸ºä¸‰ä¸ªï¼Œé‚£ä¹ˆä¸€ä¸ª**Pod**æ­»äº¡ï¼Œ**å‰¯æœ¬é›†**å°±ä¼šåˆ›å»ºä¸€ä¸ª**Pod**ï¼Œä½¿å…¶æˆä¸ºä¸‰ä¸ªã€‚
- Ingress: è·¯ç”± Http è¯·æ±‚
  - æµé‡è·¯ç”±ç”± Ingress èµ„æºä¸Šå®šä¹‰çš„è§„åˆ™æ§åˆ¶

### 4.3 å­˜å‚¨ç±»

- `Volume`: å­˜å‚¨å·ï¼Œæ˜¯ Pod ä¸­èƒ½è¢«å¤šä¸ªå®¹å™¨è®¿é—®çš„å…±äº«ç›®å½•
  - emptyDir: k8s è‡ªåŠ¨åˆ›å»ºçš„ç›®å½•ï¼ŒPod ç§»é™¤æ—¶ä¼šé”€æ¯ï¼Œæ˜¯ä¸€ä¸ªä¸´æ—¶ç©ºé—´
  - hostPath: åœ¨ Pod ä¸ŠæŒ‚è½½**å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•**
    - å¦‚æ—¥å¿—æ–‡ä»¶éœ€è¦å­˜å‚¨åœ¨å®¿ä¸»æœºç›®å½•
    - å¦‚éœ€è¦è®¿é—®å®¿ä¸»æœº Docker çš„ç›®å½•

_k8s æ¶æ„_ï¼š

![k8sæ¶æ„](./img/k8s_architecture.png)

## 5. Pod

> K8s çš„æœ€å°å·¥ä½œå•ä½ï¼›
>
> Pod å†…æ˜¯å®¹å™¨ï¼›
>
> Pod å†…çš„å®¹å™¨å¯ä»¥èµ„æºå…±äº«ã€é€šä¿¡ï¼›

### 5.1 Pod çš„ç»„æˆ

>

åˆ›å»º Pod æœ‰ä¸¤ç§æ–¹å¼ï¼š

1. ä½¿ç”¨ YAML æ–‡ä»¶åˆ›å»º

```shell
kubectl apply [XXX.yaml]
```

## 6. Deploymentï¼ˆå·¥ä½œè´Ÿè½½ï¼‰

> ä¸º Pods å’Œ ReplicaSets æä¾›å£°æ˜å¼çš„æ›´æ–°èƒ½åŠ›ã€‚

## 7. Ingressï¼ˆè·¯ç”±ï¼‰

> Ingress ç®¡ç† HTTP è¯·æ±‚çš„è·¯ç”±åˆ°ç‰¹å®šçš„ Service. å¯åšè´Ÿè½½å‡è¡¡ç­‰ã€‚

![Ingress](./img/ingress.png)

## å‚è€ƒ

ã€ŠKubernetes æƒå¨æŒ‡å—--ç¬¬ 5 ç‰ˆã€‹

[å›¾è§£ k8s æ¶æ„](https://phoenixnap.com/kb/understanding-kubernetes-architecture-diagrams)
