# Kubernetes æ ¸å¿ƒæ¦‚å¿µ

> 2021å¹´ï¼Œæƒ³éƒ¨ç½²ä¸€ä¸ªåº”ç”¨çš„è¯ï¼ŒDockeråº”è¯¥æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œk8sæ˜¯å¿…å¤‡æŠ€èƒ½ã€‚

## 1.  ä»€ä¹ˆæ˜¯k8s?

**k8s**æ˜¯ä¸€ä¸ªåŸºäº`å®¹å™¨`çš„åˆ†å¸ƒå¼æ¶æ„æ–¹æ¡ˆã€‚

å…³äºk8sçš„ä½ è¦çŸ¥é“ï¼š
- å®ƒçš„å‰èº«æ˜¯Googleçš„Brog(google å†…éƒ¨è¶…çº§å¼ºå¤§çš„é›†ç¾¤ç®¡ç†ç³»ç»Ÿ)
- k8så¯ä»¥å¢åŠ è¿ç»´æ•ˆç‡ï¼Œå‡å°‘è¿ç»´æˆæœ¬
- K8s æ˜¯ä¸€ä¸ªå¼€æ”¾æ€§çš„å¼€å‘å¹³å°ï¼Œå’Œè¯­è¨€æ— å…³ï¼ˆæ— è®ºä½ çš„é¡¹ç›®ä½¿ç”¨çš„æ˜¯Javaã€Goã€Pythonè¿˜æ˜¯NodeJsï¼‰
- K8s æ˜¯ä¸€ä¸ªå®Œå¤‡çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ”¯æ’‘å¹³å°ï¼Œå…·æœ‰å®Œå¤‡çš„é›†ç¾¤ç®¡ç†èƒ½åŠ›

## 2. k8sä¼˜ç‚¹

- å›¢é˜Ÿå¯ä»¥â€œè½»è£…ä¸Šé˜µâ€ï¼Œéœ€è¦çš„è¿ç»´å·¥ä½œé‡å¤§å¤§å‡å°‘ï¼Œè´¨é‡å¤§å¤§æé«˜
- æ‹¥æŠ±**å¾®æœåŠ¡**
- å¯ä»¥éšæ—¶éšåœ°å°†ç³»ç»Ÿâ€œæ¬è¿â€ä¸Šäº‘
- **å¼¹æ€§æ‰©å®¹**å¯ä»¥è½»æ¾åº”å¯¹æµé‡é«˜å³°
- å¯ä»¥å¿«é€Ÿæ¨ªå‘æ‰©å®¹ï¼Œè½»æ¾åº”å¯¹ç”¨æˆ·æ¿€å¢

## 3. k8s æ ¸å¿ƒæ¦‚å¿µ

k8sä¸­çš„æœ¯è¯­å¤§å¤šå›´ç»•`èµ„æºå¯¹è±¡ï¼ˆResource Objectï¼‰`è€Œè¨€çš„ï¼Œå¯ä»¥å¤§è‡´åˆ†ä¸ºä¸¤ç±»ï¼š

#### 1. æŸç§å…·ä½“èµ„æºå¯¹è±¡ï¼šå¦‚ï¼šèŠ‚ç‚¹ï¼ˆNodeï¼‰ã€Podã€æœåŠ¡ï¼ˆServiceï¼‰ã€å­˜å‚¨å·ï¼ˆVolumeï¼‰

#### 2. ä¸èµ„æºç›¸å…³çš„äº‹ç‰©ä¸åŠ¨ä½œï¼šå¦‚ï¼šæ ‡ç­¾ï¼ˆLabelï¼‰ã€æ³¨é‡Šï¼ˆAnnotationï¼‰ã€å‘½åç©ºé—´ï¼ˆNamespaceï¼‰ã€éƒ¨ç½²ï¼ˆDeploymentï¼‰ã€HPAã€PVCç­‰ã€‚

`èµ„æºå¯¹è±¡ï¼ˆResource Objectï¼‰`é€šå¸¸ä¸€å®šæœ‰åç§°ã€æ ‡ç­¾ã€æ³¨é‡Šè¿™3ä¸ªå…ƒæ•°æ®ï¼ˆmetadataï¼‰ï¼›

æˆ‘ä»¬å¯ä»¥é€šè¿‡YAMLæˆ–JSONæ ¼å¼æ¥å£°æ˜ä¸€ä¸ªK8s`èµ„æºå¯¹è±¡ï¼ˆResource Objectï¼‰`ï¼Œç„¶åæŠŠå®ƒä»¬å­˜æ”¾åœ¨etcdè¿™æ ·çš„éå…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œä¾¿äºå¿«é€Ÿè¯»å†™ï¼›

`èµ„æºå¯¹è±¡ï¼ˆResource Objectï¼‰`ä¹Ÿå¯ä»¥ä½¿ç”¨*kubectl*å·¥å…·æ‰§è¡Œå¢ã€åˆ ã€æ”¹ã€æŸ¥ã€‚

*ä¸€ä¸ªk8sç¼–æ’æ–‡ä»¶é‡Œå«æœ‰å¤šä¸ª`èµ„æºå¯¹è±¡ï¼ˆResource Objectï¼‰`ï¼š*

```yaml
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: azure-vote-back
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: azure-vote-back
    spec:
      containers:
      - name: azure-vote-back
        image: redis
        ports:
        - containerPort: 6379
          name: redis
---
apiVersion: v1
kind: Service
metadata:
  name: azure-vote-back
spec:
  ports:
  - port: 6379
  selector:
    app: azure-vote-back
---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: azure-vote-front
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: azure-vote-front
    spec:
      containers:
      - name: azure-vote-front
        image: microsoft/azure-vote-front:v1
        ports:
        - containerPort: 80
        env:
        - name: REDIS
          value: "azure-vote-back"
---
apiVersion: v1
kind: Service
metadata:
  name: azure-vote-front
spec:
  type: LoadBalancer
  ports:
  - port: 80
  selector:
    app: azure-vote-front
```

*k8sèµ„æºå¯¹è±¡å›¾ç¤ºï¼š*

![](./img/k8s_resourceObject.jpeg)

### 3.1 é›†ç¾¤ç±»

é›†ç¾¤ä¸­çš„æœºå™¨è¢«åˆ’åˆ†ä¸ºä¸€ä¸ª**Master**å’Œå¤šä¸ª**Node**

- `Master`ä¸Šè¿è¡Œç€ç®¡ç†é›†ç¾¤çš„è¿›ç¨‹ï¼Œå¦‚ï¼š
  - **kube-apiserver**ï¼šæ¥å£APIï¼Œé€šè¿‡æ¥å£å¯ä»¥å¯¹å®¹å™¨é‡Œæ‰€æœ‰èµ„æºå¢åˆ æ”¹æŸ¥--é›†ç¾¤çš„å…¥å£ï¼›
  - **kube-controller-manager**ï¼šå¯¹k8sçš„èµ„æºè‡ªåŠ¨åŒ–æ§åˆ¶--å¤§æ€»ç®¡ï¼›
  - **kube-sechuduler**ï¼šå®ƒä»¬å®ç°äº†å¯¹é›†ç¾¤çš„èµ„æºç®¡ç†ã€Podè°ƒåº¦ã€å¼¹æ€§ä¼¸ç¼©ç­‰--è°ƒåº¦å®¤
- **`Node`**: é›†ç¾¤çš„å·¥ä½œèŠ‚ç‚¹ï¼Œå…¶ä¸Šè¿è¡Œç€å…·ä½“çš„å·¥ä½œè¿›ç¨‹ï¼Œå¦‚ï¼š
  - **kubelet**ï¼š è´Ÿè´£Podå¯¹å®¹å™¨çš„åˆ›å»ºã€å¯åœç­‰ä»»åŠ¡ğŸŒŸğŸŒŸï¼Œä¸Masteråä½œï¼Œå®ç°é›†ç¾¤ç®¡ç†çš„åŸºæœ¬åŠŸèƒ½
  - **kube-proxy**ï¼šè´Ÿè´£*kubenetes service*çš„**é€šä¿¡**ï¼Œä»¥åŠå®ç°è½¯ä»¶æ¨¡å¼çš„**è´Ÿè½½å‡è¡¡**ğŸŒŸğŸŒŸ

### 3.2 åº”ç”¨ç±»

- `Deploayment`: å·¥ä½œè´Ÿè½½
  - æä¾›äº†Podçš„æ¨¡ç‰ˆï¼Œå®ç°è‡ªåŠ¨åˆ›å»ºPod
- `Service`ï¼šk8sä½¿ç”¨Serviceæ¥è¿æ¥æŒ‡å®šçš„æœåŠ¡
  - æ‹¥æœ‰ä¸€ä¸ªæŒ‡å®šçš„åç§°ï¼Œå¯ä»¥æ˜¯å¤šä¸ªå‰¯æœ¬æä¾›æœåŠ¡ï¼ˆæ— çŠ¶æ€ï¼‰ï¼Œä¹Ÿå¯æ˜¯æŸä¸ªå…·ä½“çš„æœåŠ¡ï¼Œå¦‚ mysql-server
  - æ‹¥æœ‰ä¸€ä¸ªè™šæ‹ŸIPå’Œç«¯å£å·ï¼ˆClusterIPï¼‰ï¼šå¦‚ 192.13.34.4:3001ï¼Œè¿™ä¸ªK8s çš„é‡è¦â€¼ï¸æœºåˆ¶ï¼Œå®ƒå®ç°äº†k8så†…éƒ¨DNSé‡Œ**åç§°---IP**çš„æ˜ å°„ï¼Œå¯ä»¥é€šè¿‡**åç§°**ç›´æ¥æ‰¾åˆ°**æœåŠ¡**
  - å¯ä»¥å°†å®¢æˆ·ç«¯å¯¹æœåŠ¡çš„è®¿é—®è¯·æ±‚è½¬å‘åˆ°ä¸€ç»„å®¹å™¨
- `Pod`ï¼šæœåŠ¡è¿›ç¨‹å®¹å™¨åœ¨Podä¸­è¿è¡Œ
  - **Pod**æ˜¯K8sç®¡ç†çš„æœ€å°å•ä½
  - **Pod**è¿è¡Œåœ¨ä¸€ä¸ªè¢«ç§°ä¸º**èŠ‚ç‚¹ï¼ˆNodeï¼‰**çš„ç¯å¢ƒä¸­ï¼Œ**èŠ‚ç‚¹ï¼ˆNodeï¼‰**å¯ä»¥æ˜¯ç‰©ç†æœºï¼Œä¹Ÿå¯ä»¥æ˜¯äº‘å¹³å°çš„è™šæ‹Ÿæœº
  - ä¸€ä¸ª**èŠ‚ç‚¹ï¼ˆNodeï¼‰**å¯ä»¥è¿è¡Œå¤šä¸ª**Pod**
  - æ¯ä¸ªPodä¸­éƒ½è¿è¡Œç€ä¸€ä¸ªç‰¹æ®Šçš„è¢«ç§°ä¸º**Pause**çš„å®¹å™¨ï¼Œå…¶ä»–å®¹å™¨åˆ™ä¸º**ä¸šåŠ¡å®¹å™¨**ï¼Œ**ä¸šåŠ¡å®¹å™¨**å…±äº«**Pause**å®¹å™¨å†…çš„*ç½‘ç»œ*å’Œ*Volume*ï¼Œå› æ­¤ï¼Œå®ƒä»¬ä¹‹é—´çš„é€šä¿¡å’Œæ•°æ®äº¤æ¢æ˜¯é«˜æ•ˆçš„
  - ä¸ºäº†å»ºç«‹Service å’Œ Podçš„è¿æ¥ï¼Œéœ€è¦ç»™Podè´´ä¸Š**æ ‡ç­¾**ï¼ˆå¦‚ï¼šname = mysqlã€name=phpï¼‰
  - **Deploymentå®šä¹‰æ–‡ä»¶**ï¼Œå®šä¹‰äº†Podï¼Œk8så¯ä»¥æ ¹æ®**Deployment**æ¥è‡ªåŠ¨åˆ›å»ºç¬¦åˆè¦æ±‚çš„Podï¼Œå¤§å¤§æé«˜è¿ç»´æ•ˆç‡
- `Label`:è¿™é‡Œçš„LabelæŒ‡ä¸€ä¸ª key=value é”®å€¼å¯¹
  - ä¸€ä¸ªLabelå¯ä»¥æ·»åŠ ç»™å¤šä¸ªèµ„æºå¯¹è±¡ï¼Œå¦‚Nodeã€Podã€Serviceã€Deploymentç­‰
  - ä¸€ä¸ªèµ„æºå¯¹è±¡ä¸Šå¯ä»¥æœ‰å¤šä¸ªLabel
  - Labelä½œç”¨æ˜¯ï¼šè®©èµ„æºå®ç°**å¤šç»´åº¦åˆ†ç»„ç®¡ç†åŠŸèƒ½**ğŸŒŸï¼Œå’ŒLabel Select å…±åŒæ„æˆäº†K8sç³»ç»Ÿæ ¸å¿ƒçš„åº”ç”¨æ¨¡å‹
  - Labelæ˜¯Podçš„é‡è¦å±æ€§ï¼Œé‡è¦æ€§ä»…æ¬¡äºPodçš„ç«¯å£
  - **Label Selector(æ ‡ç­¾é€‰æ‹©å™¨)**ï¼šæŸ¥è¯¢å’Œç­›é€‰æ‹¥æœ‰æŸäº›Labelçš„èµ„æºå¯¹è±¡
- `Serviceç½‘ç»œé€šä¿¡`
  - Node IPï¼šçœŸå®æœåŠ¡å™¨çš„IPåœ°å€ï¼ŒK8sèŠ‚ç‚¹å¤–çš„Node IP å¯ä»¥è®¿é—®K8sé‡Œçš„TCP/IPæœåŠ¡ï¼ŒçœŸå®çš„TCP/IPæµé‡æ˜¯Node IPæ‰€åœ¨çš„ç½‘å¡æµå‡ºçš„
  - Pod IPï¼šæ¯ä¸ªPodçš„IPåœ°å€ï¼Œä½¿ç”¨Dockeråšå®¹å™¨æ—¶ï¼Œå®ƒæ˜¯Docker Engineæ ¹æ® docker0 ç½‘æ¡¥çš„IPåˆ†é…çš„ï¼Œæ˜¯ä¸€ä¸ªè™šæ‹ŸäºŒå±‚ç½‘ç»œã€‚K8sé›†ç¾¤é‡Œçš„Podé—´é€šä¿¡å°±æ˜¯é€šè¿‡è¿™ä¸ªäºŒå±‚ç½‘ç»œ
  - `Service IP`: Service çš„ ClusterIP åœ°å€å±äºé›†ç¾¤å†…çš„åœ°å€ï¼Œæ— æ³•åœ¨é›†ç¾¤å¤–ç›´æ¥ä½¿ç”¨ã€‚**NodePort**è§£å†³äº†é›†ç¾¤å¤–è®¿é—®é›†ç¾¤å†…æœåŠ¡çš„ç›´æ¥æœ‰æ•ˆã€æœ‰æ•ˆæ–¹æ³•ã€‚
- `Replica Set(å‰¯æœ¬é›†)`:
  - **å‰¯æœ¬é›†**ç¡®ä¿åœ¨ä»»ä½•æ—¶å€™éƒ½æœ‰æŒ‡å®šæ•°é‡çš„podå¤åˆ¶åœ¨è¿è¡Œ
  - **å‰¯æœ¬é›†**å¸®åŠ©ä½ å®šä¹‰å¤šå°‘ä¸ª**Pod**æ˜¯å¯ç”¨çš„ï¼Œå¦‚æœä½ æŠŠ**å‰¯æœ¬é›†**å®šä¹‰ä¸ºä¸‰ä¸ªï¼Œé‚£ä¹ˆä¸€ä¸ª**Pod**æ­»äº¡ï¼Œ**å‰¯æœ¬é›†**å°±ä¼šåˆ›å»ºä¸€ä¸ª**Pod**ï¼Œä½¿å…¶æˆä¸ºä¸‰ä¸ªã€‚
- Ingress: è·¯ç”±Httpè¯·æ±‚
  - æµé‡è·¯ç”±ç”±Ingress èµ„æºä¸Šå®šä¹‰çš„è§„åˆ™æ§åˆ¶

### 3.3 å­˜å‚¨ç±»

- `Volume`: å­˜å‚¨å·ï¼Œæ˜¯Pod ä¸­èƒ½è¢«å¤šä¸ªå®¹å™¨è®¿é—®çš„å…±äº«ç›®å½•
  - emptyDir: k8sè‡ªåŠ¨åˆ›å»ºçš„ç›®å½•ï¼ŒPodç§»é™¤æ—¶ä¼šé”€æ¯ï¼Œæ˜¯ä¸€ä¸ªä¸´æ—¶ç©ºé—´
  - hostPath: åœ¨Pod ä¸ŠæŒ‚è½½**å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•**
    - å¦‚æ—¥å¿—æ–‡ä»¶éœ€è¦å­˜å‚¨åœ¨å®¿ä¸»æœºç›®å½•
    - å¦‚éœ€è¦è®¿é—®å®¿ä¸»æœºDockerçš„ç›®å½•

*k8sæ¶æ„*ï¼š

![k8sæ¶æ„](./img/k8s_architecture.png)

## 4. Deploymentï¼ˆå·¥ä½œè´Ÿè½½ï¼‰

> ä¸º Pods å’Œ ReplicaSets æä¾›å£°æ˜å¼çš„æ›´æ–°èƒ½åŠ›ã€‚

## 5. Ingressï¼ˆè·¯ç”±ï¼‰

> Ingress ç®¡ç† HTTP è¯·æ±‚çš„è·¯ç”±åˆ°ç‰¹å®šçš„ Service. å¯åšè´Ÿè½½å‡è¡¡ç­‰ã€‚

![Ingress](./img/ingress.png)

## å‚è€ƒ

ã€ŠKubernetesæƒå¨æŒ‡å—--ç¬¬5ç‰ˆã€‹

[å›¾è§£k8sæ¶æ„](https://phoenixnap.com/kb/understanding-kubernetes-architecture-diagrams)

